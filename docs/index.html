#!/bin/sh
ARCH=$(uname)

check_curl(){
	which curl &> /dev/null 
	if [[ $? -ne 0 ]] ; then
			echo '"curl" binary not found, please install and retry'
			exit 1
	fi
}

get_latest_version(){
	V=$(curl --connect-timeout 100 -L -s "https://api.codenotary.io/foundation/v1/version/vcn/latest" | jq '.release')
}

check_os() {
	if [ "$ARCH" = "Linux" ] ; then
		PKG="linux"
	elif [ "$ARCH" = "Darwin" ] ; then
		PKG="darwin"
	else
		echo "Unknown operating system."
		exit 1
	fi
}

generate_url(){
	if [ "$PKG" = "linux" ] ; then
		URL="https://github.com/vchain-us/vcn/releases/download/$VERSION/vcn-$VERSION-$ARCH-amd64"
	fi

	if [ "$PKG" = "darwin" ] ; then
		URL="https://github.com/vchain-us/vcn/releases/download/$VERSION/vcn-$VERSION-$ARCH-10.6-amd64"
	fi
}

install() {
  TMPDIR=$(mktemp -d) && cd $TMPDIR
	curl --connect-timeout 100 -L $URL >> vcn

	if [ "$PKG" = "linux" ] ; then
	  sudo cp $TMPDIR/vcn /usr/bin && sudo chmod +x /usr/bin/vcn
	fi

	if [ "$PKG" = "darwin" ] ; then
	  sudo cp $TMPDIR/vcn /usr/local/bin && sudo chmod +x /usr/local/bin/vcn
	fi
}

cleanup() {
  rm $TMPDIR/*
  rmdir $TMPDIR
}

check_curl
check_os
echo  "";
echo "CodeNotary vcn CLI - Install"
echo "----------------------------"
echo "- Checking for latest release.." 
get_latest_version
echo "- Downloading and installing vcn $V for you..."
generate_url
install
cleanup
echo "";
echo "ðŸŽ‰ Done."
echo "You can run now: $ vcn"